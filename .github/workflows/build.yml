name: Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-musl
            os: ubuntu-18.04
            build-cmd: cross build
            test-cmd: cross test
          - target: aarch64-unknown-linux-musl
            os: ubuntu-18.04
            build-cmd: cross build
            test-cmd: cross test --bin terve
          - target: x86_64-apple-darwin
            os: macos-10.15
            build-cmd: cargo build
            test-cmd: cargo test
          - target: aarch64-apple-darwin
            os: macos-10.15
            build-cmd: cargo build
            test-cmd: /bin/false --nope
          - target: x86_64-pc-windows-msvc
            os: windows-2016
            build-cmd: cargo build
            test-cmd: cargo test
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          target: ${{ matrix.target }}
          components: rustfmt, clippy

      - name: Install cross for linux musl builds
        if: endsWith(matrix.target, 'linux-musl')
        run: cargo install cross

      - name: Setup environment variables for macOS arm64 build
        if: matrix.target == 'aarch64-apple-darwin'
        run: |
          echo "SDKROOT=$(xcrun -sdk macosx11.1 --show-sdk-path)" >> $GITHUB_ENV
          echo "MACOSX_DEPLOYMENT_TARGET=$(xcrun -sdk macosx11.1 --show-sdk-platform-version)" >> $GITHUB_ENV

      - name: Run debug build
        run: ${{ matrix.build-cmd }} --target ${{ matrix.target }}

      - name: Run tests
        if: matrix.target != 'aarch64-apple-darwin'
        run: ${{ matrix.test-cmd }} --target ${{ matrix.target }}

      - name: Run fmt check
        run: cargo fmt --all -- --check

      - name: Run clippy lints
        run: cargo clippy -- -D warnings
